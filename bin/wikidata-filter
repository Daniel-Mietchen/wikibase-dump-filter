#!/usr/bin/env node
const program = require('commander')
const package = require('../package.json')
const getEntitiesStream = require('../lib/get_entities_stream')
const filterEntity = require('../lib/filter_entity')
const formatEntity = require('../lib/format_entity')
const serializeEntity = require('../lib/serialize_entity')
const handleErrors = require('../lib/handle_errors')
const progressBar = require('../lib/progress_bar')
const help = require('../lib/help')
const list = val => val.split(',')

const options = program
  .version(package.version)
  // filters
  .option('-t, --type <type>', help.type)
  .option('-c, --claim <claim>', help.claim)
  .option('-i, --sitelink <sitelink>', help.sitelink)
  // formatters
  .option('-o, --omit <attributes>', help.omit, list)
  .option('-k, --keep <attributes>', help.keep, list)
  .option('-l, --languages <languages>', help.languages, list)
  .option('-s, --simplify [boolean|options]', help.simplify)
  // misc
  .option('-p, --progress', help.progress)
  .parse(process.argv)

const isntTTY = process.stdout.isTTY == null
const progress = options.progress !== 'false' && (isntTTY || options.progress === 'true')

var total = 0
var filtered = 0
const incrementTotal = () => total++
const updateProgressBar = entity => {
  filtered++
  if (progress) progressBar(entity.id, filtered, total)
}

getEntitiesStream(process.stdin)
.tap(incrementTotal)
.filter(filterEntity(options))
.map(formatEntity(options))
.tap(updateProgressBar)
.map(serializeEntity)
.pipe(process.stdout)
.on('error', handleErrors)
